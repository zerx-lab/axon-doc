# AxonDoc Deployment

One-command deployment with Docker Compose. Includes Supabase + Application stack.

## Quick Start

```bash
# 1. Clone repository
git clone https://github.com/zerx-lab/axon-doc.git
cd axon-doc/deployment

# 2. Run setup (auto-generates secrets and starts services)
chmod +x setup.sh
./setup.sh

# 3. Access
# App:       http://localhost:3001  (admin / admin123)
# API:       http://localhost:8000
# Dashboard: http://localhost:8000  (supabase / <see .env>)
```

## Manual Setup

```bash
# 1. Copy environment file
cp .env.example .env

# 2. Generate secrets (or edit manually)
./setup.sh --generate-keys

# 3. Start services
docker compose up -d

# 4. Check status
docker compose ps
```

## Directory Structure

```
deployment/
├── docker-compose.yml      # Complete stack (Supabase + App)
├── .env.example            # Environment template
├── setup.sh                # Quick setup script
├── volumes/                # Service configurations
│   ├── api/kong.yml        # API Gateway config
│   ├── db/*.sql            # Database init scripts
│   ├── logs/vector.yml     # Log collection config
│   └── pooler/pooler.exs   # Connection pooler config
└── docs/                   # Additional documentation
```

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                        Browser                          │
└─────────────────────────┬───────────────────────────────┘
                          │
          ┌───────────────┴───────────────┐
          │                               │
    ┌─────▼─────┐                 ┌───────▼───────┐
    │  Next.js  │                 │     Kong      │
    │   :3001   │                 │    :8000      │
    └─────┬─────┘                 └───────┬───────┘
          │                               │
   ┌──────┴──────┐          ┌─────────────┼─────────────┐
   │             │          │             │             │
┌──▼───┐   ┌─────▼─────┐  ┌─▼──┐    ┌─────▼─────┐ ┌─────▼─────┐
│Crawl │   │ PostgreSQL│  │Auth│    │  Storage  │ │ Realtime  │
│:8001 │   │   :5432   │  │    │    │           │ │           │
└──┬───┘   └───────────┘  └────┘    └───────────┘ └───────────┘
   │
┌──▼───┐
│Redis │
│:6379 │
└──────┘
```

## Services

| Service | Port | Description |
|---------|------|-------------|
| nextjs | 3001 | Next.js application |
| kong | 8000 | API Gateway |
| crawler | 8001 | Web crawler |
| db | 5432 | PostgreSQL |
| redis | 6379 | Cache |
| auth | - | Supabase Auth |
| storage | - | File storage |
| realtime | - | Realtime subscriptions |

## Commands

```bash
# Start
docker compose up -d

# Stop
docker compose down

# Logs
docker compose logs -f [service]

# Reset (deletes all data!)
docker compose down -v
docker compose up -d

# Update
docker compose pull
docker compose up -d

# Status
docker compose ps
```

## Configuration

### Required Settings

Edit `.env` before deployment:

```bash
# Database
POSTGRES_PASSWORD=<strong-password>

# JWT (generate: openssl rand -hex 32)
JWT_SECRET=<32-char-secret>

# Supabase Keys (auto-generated by setup.sh)
ANON_KEY=<jwt-token>
SERVICE_ROLE_KEY=<jwt-token>

# URLs (update for production)
SITE_URL=https://your-domain.com
API_EXTERNAL_URL=https://api.your-domain.com
PUBLIC_SUPABASE_URL=https://api.your-domain.com
```

### Optional Settings

```bash
# Email (for auth emails)
SMTP_HOST=smtp.example.com
SMTP_USER=user
SMTP_PASS=pass

# Dashboard auth
DASHBOARD_USERNAME=admin
DASHBOARD_PASSWORD=<password>
```

## Production Checklist

- [ ] Generate strong secrets with `./setup.sh --generate-keys`
- [ ] Update URLs for your domain
- [ ] Configure SMTP for email auth
- [ ] Set up reverse proxy (nginx/traefik) with SSL
- [ ] Configure backups for `postgres-data` volume
- [ ] Change default admin password after first login

## Database Migrations

Migrations are loaded from `../supabase/migrations/` on first startup:

```
001_initial_schema.sql    # Core tables and functions
002_add_chat_messages_status.sql
003_add_chat_permissions_to_roles.sql
seed.sql                  # Default admin user
```

To add new migrations:
1. Create file in `supabase/migrations/` with incremental number
2. Reset database: `docker compose down -v && docker compose up -d`

## Troubleshooting

### Services not starting
```bash
docker compose logs db      # Database issues
docker compose logs kong    # API gateway issues
docker compose logs nextjs  # App issues
```

### Database connection
```bash
docker compose exec db pg_isready -U postgres
docker compose exec db psql -U postgres -c '\l'
```

### Reset everything
```bash
docker compose down -v
docker compose up -d
```

### View app logs
```bash
docker compose logs -f nextjs
docker compose logs -f crawler
```

## Updating

### Update application images
```bash
docker compose pull nextjs crawler
docker compose up -d nextjs crawler
```

### Update all services
```bash
docker compose pull
docker compose up -d
```

## Backup & Restore

### Backup database
```bash
docker compose exec db pg_dump -U postgres > backup.sql
```

### Restore database
```bash
docker compose exec -T db psql -U postgres < backup.sql
```

### Backup volumes
```bash
docker run --rm -v axon-doc_postgres-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/postgres-backup.tar.gz /data
```

---

**Version**: 2.0.0  
**Last Updated**: 2026-01-20
