name: Build and Push Docker Images to GHCR

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docker/Dockerfile.prod'
      - 'crawler-service/Dockerfile'
      - 'app/**'
      - 'lib/**'
      - 'components/**'
      - 'public/**'
      - 'crawler-service/app/**'
      - '.github/workflows/docker-build.yml'
      - 'package.json'
      - 'bun.lock'
      - 'crawler-service/pyproject.toml'
      - 'crawler-service/uv.lock'
  workflow_dispatch:

env:
  # GitHub Container Registry é…ç½®
  REGISTRY: ghcr.io
  IMAGE_NAME_NEXTJS: ${{ github.repository }}-nextjs
  IMAGE_NAME_CRAWLER: ${{ github.repository }}-crawler

jobs:
  # ==========================================
  # æ„å»ºå¹¶æ¨é€ Next.js é•œåƒåˆ° GHCR
  # ==========================================
  build-nextjs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“ ç”Ÿæˆé•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_NEXTJS }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€ Next.js é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: ğŸ“¢ è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "âœ… Next.js é•œåƒå·²æ¨é€"
          echo "é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_NEXTJS }}"
          echo "æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"

  # ==========================================
  # æ„å»ºå¹¶æ¨é€ Crawler é•œåƒåˆ° GHCR
  # ==========================================
  build-crawler:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“ ç”Ÿæˆé•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_CRAWLER }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€ Crawler é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./crawler-service
          file: ./crawler-service/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: ğŸ“¢ è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "âœ… Crawler é•œåƒå·²æ¨é€"
          echo "é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_CRAWLER }}"
          echo "æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"

  # ==========================================
  # è§¦å‘æœåŠ¡å™¨éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰
  # ==========================================
  notify-deploy:
    needs: [build-nextjs, build-crawler]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“§ é€šçŸ¥éƒ¨ç½²æœåŠ¡
        run: |
          echo "ğŸš€ æ–°é•œåƒå·²æ„å»ºå®Œæˆ"
          echo "ä¸‹ä¸€æ­¥ï¼š"
          echo "1. åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ: docker-compose -f docker-compose.prod.yml pull"
          echo "2. ç„¶åè¿è¡Œ: docker-compose -f docker-compose.prod.yml up -d"
          echo ""
          echo "æˆ–ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼š"
          echo "  cd deployment && ./scripts/deploy.sh update-images"

      - name: ğŸ”” å‘é€ Webhook é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: secrets.DEPLOY_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.DEPLOY_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "event": "image_build_complete",
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "sha": "${{ github.sha }}",
              "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
              "images": {
                "nextjs": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_NEXTJS }}:latest",
                "crawler": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_CRAWLER }}:latest"
              }
            }'
